## Next Steps

*   **Enhance Diagram Generation:**
    * Add support for more complex diagram types (state diagrams, entity-relationship diagrams)
    * Implement diagram customization options (colors, styles, layouts)
    * Add support for more Mermaid themes and theme switching

## Completed Tasks

1.  **Add a dropdown that can change the theme of the diagram.**
    *   Added a `<select>` dropdown to the webview HTML generated by `/simpleUML`, `/relationUML`, and the `RenderDiagramTool` (in `src/tool-handlers.ts`).
    *   Added JavaScript to handle dropdown changes, re-initializing/re-rendering the Mermaid diagram with the selected theme (`default`, `neutral`, `dark`, `forest`).
    *   Set `retainContextWhenHidden: true` for webviews to preserve theme selection.
2.  **Add a "Save Diagram" Button:**
    1.  **Declare Command:** Defined `diagram.saveAs` in `package.json`.
    2.  **Register Command:** Registered handler in `extension.ts` using `vscode.commands.registerCommand`, implementing save dialog and file writing.
    3.  **Create Button Command:** Created `vscode.Command` object in the `/fromCurrentFile` and `/showConnections` handlers in `src/simple.ts`.
    4.  **Add Button to Stream:** Called `stream.button()` in the `/fromCurrentFile` and `/showConnections` handlers to display the button.

3.  **Bug Fixes:**
    *   Fixed webview panel rendering regression in `RenderDiagramTool`

4.  **Command Structure Cleanup:**
    *   Removed `/randomTeach` endpoint
    *   Removed `/play` endpoint
    *   Simplified command structure to focus on diagram-related functionality

5.  **Tool Implementation:**
    *   Implemented proper tool classes with `vscode.LanguageModelTool` interface
    *   Created `GetCodeContextTool` and `RenderDiagramTool` classes
    *   Fixed tool result handling with proper types
    *   Added tool registration in `src/diagram-tools.ts`

6.  **Auto-Detection of Diagram Type:**
    *   Updated prompts and tool handling to automatically detect appropriate diagram types
    *   Implemented code analysis for diagram type selection
    *   Added requirement for model to explain diagram type choices

7.  **Documentation Updates:**
    *   Updated README.md to reflect new diagram-focused functionality
    *   Added documentation for `/fromCurrentFile` command
    *   Updated current state and next steps documentation

8.  **Connection Visualization:**
    *   Implemented `/showConnections` command to show object relationships
    *   Added support for inheritance, composition, and aggregation relationships
    *   Enhanced diagram generation to include related objects and their connections
    *   Added dark mode support for connection diagrams

9.  **Implement PNG/SVG Rendering for Save:**
    *   Integrated the Mermaid CLI (`mmdc`) via `@mermaid-js/mermaid-cli` dev dependency.
    *   Modified the `diagram.saveAs` command handler in `src/extension.ts` to render PNG/SVG using `mmdc`.
    *   Writes image data for `.png` and `.svg` extensions.
    *   Added error handling for `mmdc` execution (not found, rendering errors).
    *   Checks for `mmdc` existence before attempting render.

10. **Improved Save Diagram Functionality:**
    *   Used the Mermaid CLI (`mmdc`) to convert diagrams to SVG/PNG on save.
    *   Checked if `mmdc` is installed; prompt user if not.
    *   Handled `.svg`, `.png`, `.mmd`, and `.md` file extensions during save.
    *   Used `child_process` to run `mmdc`.
    *   Added error handling for the conversion process.

### 3. Add Export/Save Functionality

*Goal: Allow users to save the generated Mermaid diagrams in various formats.* Currently implemented for diagrams generated via `/simpleUML`, `/relationUML`, and `/sequence` command (via the `renderDiagram` tool).

1.  **Define Export Formats:** Decided on `.mmd` (raw syntax), `.md` (Markdown code block), `.svg`, and `.png`.
2.  **Webview Controls:**
    *   Added an "Export Diagram" button/dropdown to the webview HTML (`src/views/mermaid-webview-template.ts`).
    *   The dropdown lists the export formats (SVG, PNG, MMD, MD).
    *   Added JavaScript in the webview to handle button clicks/dropdown selections and send a `postMessage` back to the extension with the desired format, current theme, and the original Mermaid syntax.
3.  **Register `diagram.saveAs` Command:** Created a new command in `src/extension.ts`.
4.  **Implement `diagram.saveAs` Logic:**
    *   Takes Mermaid syntax, optional format, optional theme, and optional base filename as arguments.
    *   If format is not provided, shows a `showSaveDialog` with filters for all supported formats.
    *   If format *is* provided (e.g., from webview message), shows `showSaveDialog` filtered for that specific format.
    *   Handles `.mmd` and `.md` export by writing the syntax directly.
    *   Handles `.svg` and `.png` export:
        *   Requires `@mermaid-js/mermaid-cli` (added to `devDependencies`).
        *   Writes the syntax to a temporary `.mmd` file.
        *   Uses `child_process.execFile` to run `mmdc` with the temp input file, theme, and desired output file.
        *   Reads the generated output file (SVG/PNG).
        *   Includes a helper `findMmdcPath` to locate the `mmdc` executable (checks local `node_modules/.bin` first, then some global paths).
        *   Includes error handling for `mmdc` execution.
        *   Cleans up temporary files.
    *   Writes the final content (string or `Uint8Array`) to the user-selected save URI using `vscode.workspace.fs.writeFile`.
5.  **Handle Webview Messages:** Added `panel.webview.onDidReceiveMessage` listeners in `createAndShowDiagramWebview` (`src/simple.ts`) and in the `RenderDiagramTool` (`src/tool-handlers.ts`) to receive the `exportDiagram` message from the webview and execute the `diagram.saveAs` command with the necessary arguments.
6.  **Add Save Button to Chat:**
    *   Added a `stream.button()` call in `createAndShowDiagramWebview` (`src/simple.ts`) after successfully rendering a diagram for `/simpleUML` and `/relationUML`.
    *   The button triggers the `diagram.saveAs` command, passing the Mermaid syntax and a suggested base filename (e.g., `simpleUML-diagram`).

### 4. Refactor Command Handling & Add `/relationUML`

*Goal: Improve code structure and add a command specifically for object relationships.* Refactoring was done incrementally alongside other features.

1.  **`CommandHandlerParams` Interface:** Defined an interface (`src/simple.ts`) to standardize parameters passed to command handlers.
2.  **Helper Functions:** Extracted logic into smaller, focused functions like `createAndShowDiagramWebview`, `validateMermaidSyntax`, `handleError`.
3.  **Main Handler Logic:** Simplified the main `handler` in `registerSimpleParticipant` (`src/simple.ts`) to primarily route requests to specific command handlers based on `request.command`.
4.  **Implemented `/relationUML` command:** (`handleRelationUML` in `src/simple.ts`)
    *   Added command definition to `package.json`.
    *   Created a specific prompt instructing the LLM to focus on class/object relationships.
    *   Calls the LLM directly using `lm.sendRequest`.
    *   Processes the response stream to extract the Mermaid block.
    *   Uses `createAndShowDiagramWebview` for validation and display.
    *   Added specific logging for `relationUML`.
5.  **Pass `lm` and `codeContext`:** Modified the main handler to fetch the `LanguageModelChat` instance (`lm`) and the editor code context (`codeContext`) once and pass them down through the `CommandHandlerParams` object to the specific handlers that need them.

### 5. Syntax Validation (Server-Side)

*Goal: Prevent errors when rendering invalid Mermaid syntax generated by the LLM.*

1.  **Dependencies:** Added `jsdom` and `dompurify` to `devDependencies`.
2.  **`validateMermaidSyntax` Helper:** Created an async function in `src/simple.ts`.
3.  **JSDOM Setup:**
    *   Creates a `JSDOM` instance.
    *   Creates `DOMPurify` attached to the JSDOM `window`.
    *   Temporarily sets `global.window`, `global.document`, etc., to the JSDOM equivalents (Mermaid expects these).
    *   Dynamically imports `mermaid`.
    *   Initializes Mermaid and calls `mermaid.parse(syntax)` within a `try...catch` block.
    *   **Crucially:** Restores the original global properties in a `finally` block to prevent side effects.
4.  **Integration:** Called `validateMermaidSyntax` from within `createAndShowDiagramWebview` *before* attempting to set the webview HTML.
5.  **Feedback:** If validation fails, markdown message is sent to the chat via the `stream`, and the webview is not shown/updated.

---

